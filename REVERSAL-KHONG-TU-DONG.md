# LÃ€M RÃ•: REVERSAL KHÃ”NG Tá»° Äá»˜NG - NGÆ¯á»œI DÃ™NG CHá»ŒN

## âŒ HIá»‚U NHáº¦M PHá»” BIáº¾N

```
User nghÄ© sai:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ TÃ´i click nÃºt [XÃ“A] giao dá»‹ch GD20251218-0694  â”‚
â”‚           â†“                                     â”‚
â”‚ Há»‡ thá»‘ng Tá»° Äá»˜NG táº¡o giao dá»‹ch Ä‘áº£o ngÆ°á»£c       â”‚
â”‚           â†“                                     â”‚
â”‚ CÃ³ 2 giao dá»‹ch: gá»‘c + reversal                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âœ… THá»°C Táº¾

```
Thá»±c táº¿:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ NgÆ°á»i dÃ¹ng phÃ¡t hiá»‡n giao dá»‹ch GD20251218-0694         â”‚
â”‚           â†“                                             â”‚
â”‚ NgÆ°á»i dÃ¹ng CHá»ŒN 1 trong 4 hÃ nh Ä‘á»™ng:                   â”‚
â”‚  [1] REVERSAL     (táº¡o Ä‘áº£o ngÆ°á»£c)                      â”‚
â”‚  [2] SOFT DELETE  (xÃ³a má»m)                            â”‚
â”‚  [3] REPLACEMENT  (thay tháº¿)                           â”‚
â”‚  [4] KHÃ”NG LÃ€M GÃŒ (giá»¯ nguyÃªn)                         â”‚
â”‚           â†“                                             â”‚
â”‚ Há»‡ thá»‘ng thá»±c hiá»‡n ÄÃšNG THEO lá»±a chá»n                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## ğŸ¯ 4 Lá»°A CHá»ŒN CHI TIáº¾T

### Lá»°A CHá»ŒN 1: REVERSAL (Äáº£o ngÆ°á»£c)

**Khi nÃ o:** Giao dá»‹ch Ä‘Ã£ ghi ÄÃšNG nhÆ°ng cáº§n Há»¦Y Bá»

**VÃ­ dá»¥ thá»±c táº¿:**
```
TÃ¬nh huá»‘ng: 
- NgÃ y 18/12: Chi 360,000Ä‘ mua hÃ ng tá»« nhÃ  cung cáº¥p A
- NgÃ y 20/12: NhÃ  cung cáº¥p A há»§y Ä‘Æ¡n hÃ ng, hoÃ n tiá»n
- Cáº§n ghi láº¡i viá»‡c hoÃ n tiá»n nÃ y

Sai láº§m: XÃ³a giao dá»‹ch ngÃ y 18/12
â†’ Máº¥t audit trail, khÃ´ng biáº¿t Ä‘Ã£ cÃ³ giao dá»‹ch nÃ y

ÄÃºng: Reversal giao dá»‹ch ngÃ y 18/12
â†’ Giá»¯ nguyÃªn giao dá»‹ch gá»‘c + táº¡o giao dá»‹ch Ä‘áº£o ngÆ°á»£c
â†’ Audit trail Ä‘áº§y Ä‘á»§: "ÄÃ£ chi â†’ Ä‘Ã£ hoÃ n"
```

**Workflow:**
```
User:     VÃ o giao dá»‹ch GD20251218-0694
          â†“
User:     Click nÃºt [Äáº¢O NGÆ¯á»¢C] (KHÃ”NG pháº£i nÃºt [XÃ“A])
          â†“
User:     Nháº­p lÃ½ do: "NhÃ  cung cáº¥p há»§y Ä‘Æ¡n, hoÃ n tiá»n"
          â†“
User:     Click [XÃC NHáº¬N]
          â†“
System:   Táº¡o giao dá»‹ch REV20260101174800
          - Type: THU (ngÆ°á»£c láº¡i)
          - Amount: 360,000Ä‘
          - From: BÃªn ngoÃ i â†’ Quá»¹ cÃ´ng ty
          - Note: "Äáº¢ONGU: GD20251218-0694 - NhÃ  cung cáº¥p há»§y Ä‘Æ¡n"
          â†“
System:   Cáº­p nháº­t GD20251218-0694
          - lifecycle_status = "reversed"
          - reversed_by_transaction_id = 810
          â†“
Result:   Database cÃ³ 2 giao dá»‹ch:
          - GD20251218-0694: CHI 360k (reversed)
          - REV20260101174800: THU 360k (active)
          Tá»•ng impact: 0Ä‘
```

**Command:**
```bash
php artisan transaction:reverse GD20251218-0694 "NhÃ  cung cáº¥p há»§y Ä‘Æ¡n"
```

---

### Lá»°A CHá»ŒN 2: SOFT DELETE (XÃ³a má»m)

**Khi nÃ o:** Giao dá»‹ch NHáº¬P NHáº¦M, CHÆ¯A Xáº¢Y RA thá»±c táº¿

**VÃ­ dá»¥ thá»±c táº¿:**
```
TÃ¬nh huá»‘ng:
- NhÃ¢n viÃªn nháº­p giao dá»‹ch: Chi 360,000Ä‘
- NhÆ°ng thá»±c táº¿ KHÃ”NG CÃ“ giao dá»‹ch nÃ y
- NhÃ¢n viÃªn nháº­p nháº§m hoáº·c duplicate

Sai láº§m: DÃ¹ng Reversal
â†’ Táº¡o 2 giao dá»‹ch cho viá»‡c KHÃ”NG Tá»’N Táº I
â†’ LÃ m phá»©c táº¡p sá»• sÃ¡ch

ÄÃºng: Soft Delete
â†’ áº¨n giao dá»‹ch nháº­p nháº§m
â†’ CÃ³ thá»ƒ restore náº¿u cáº§n
```

**Workflow:**
```
User:     VÃ o giao dá»‹ch GD20251218-0694
          â†“
User:     Click nÃºt [XÃ“A]
          â†“
User:     Nháº­p lÃ½ do: "Nháº­p nháº§m, khÃ´ng cÃ³ giao dá»‹ch thá»±c táº¿"
          â†“
User:     Click [XÃC NHáº¬N]
          â†“
System:   Cáº­p nháº­t GD20251218-0694
          - lifecycle_status = "cancelled"
          - deleted_at = 2026-01-02 18:00:00
          â†“
System:   KHÃ”NG Táº O giao dá»‹ch Ä‘áº£o ngÆ°á»£c
          â†“
System:   áº¨n khá»i danh sÃ¡ch giao dá»‹ch
          â†“
Result:   - Giao dá»‹ch bá»‹ áº©n (soft deleted)
          - CÃ³ thá»ƒ restore náº¿u phÃ¡t hiá»‡n xÃ³a nháº§m
          - Sá»‘ dÆ° nhÆ° chÆ°a cÃ³ giao dá»‹ch nÃ y
```

**Code:**
```php
$service->softDeleteTransaction($transaction, "Nháº­p nháº§m");
```

---

### Lá»°A CHá»ŒN 3: REPLACEMENT (Thay tháº¿)

**Khi nÃ o:** Giao dá»‹ch CÃ“ Xáº¢Y RA nhÆ°ng GHI SAI thÃ´ng tin

**VÃ­ dá»¥ thá»±c táº¿:**
```
TÃ¬nh huá»‘ng:
- Ghi: Chi 360,000Ä‘ cho nhÃ  cung cáº¥p A
- HÃ³a Ä‘Æ¡n thá»±c táº¿: 320,000Ä‘
- Cáº§n sá»­a sá»‘ tiá»n cho Ä‘Ãºng

Sai láº§m: XÃ³a + táº¡o má»›i
â†’ Máº¥t liÃªn káº¿t giá»¯a giao dá»‹ch cÅ© vÃ  má»›i
â†’ KhÃ´ng biáº¿t Ä‘Ã£ sá»­a gÃ¬

ÄÃºng: Replacement
â†’ Giá»¯ giao dá»‹ch cÅ© (marked as replaced)
â†’ Táº¡o giao dá»‹ch má»›i (active)
â†’ Biáº¿t Ä‘Æ°á»£c lá»‹ch sá»­ sá»­a
```

**Workflow:**
```
User:     VÃ o giao dá»‹ch GD20251218-0694
          â†“
User:     Click nÃºt [THAY THáº¾]
          â†“
User:     Nháº­p dá»¯ liá»‡u Ä‘Ãºng:
          - Amount: 320,000Ä‘ (thay vÃ¬ 360,000Ä‘)
          â†“
User:     Nháº­p lÃ½ do: "Sá»­a theo hÃ³a Ä‘Æ¡n thá»±c táº¿"
          â†“
User:     Click [XÃC NHáº¬N]
          â†“
System:   Táº¡o giao dá»‹ch má»›i GD20260102-0815
          - Type: CHI
          - Amount: 320,000Ä‘
          - lifecycle_status = "active"
          â†“
System:   Cáº­p nháº­t GD20251218-0694
          - lifecycle_status = "replaced"
          - replaced_by = 815
          â†“
Result:   - Giao dá»‹ch cÅ©: áº©n khá»i bÃ¡o cÃ¡o
          - Giao dá»‹ch má»›i: dÃ¹ng cho bÃ¡o cÃ¡o
          - Biáº¿t Ä‘Æ°á»£c Ä‘Ã£ sá»­a gÃ¬
```

**Code:**
```php
$service->replaceTransaction($old, [
    'amount' => 320000
], "Sá»­a theo hÃ³a Ä‘Æ¡n thá»±c táº¿");
```

---

### Lá»°A CHá»ŒN 4: KHÃ”NG LÃ€M GÃŒ

**Khi nÃ o:** Giao dá»‹ch ÄÃšNG, khÃ´ng cÃ³ váº¥n Ä‘á»

**Workflow:**
```
User:     Kiá»ƒm tra giao dá»‹ch GD20251218-0694
          â†“
User:     XÃ¡c nháº­n giao dá»‹ch Ä‘Ãºng
          â†“
User:     ÄÃ³ng mÃ n hÃ¬nh
          â†“
Result:   KhÃ´ng cÃ³ thay Ä‘á»•i
```

---

## ğŸ“Š Báº¢NG SO SÃNH

| TiÃªu chÃ­ | Reversal | Soft Delete | Replacement | KhÃ´ng lÃ m gÃ¬ |
|----------|----------|-------------|-------------|--------------|
| **Giao dá»‹ch Ä‘Ã£ xáº£y ra?** | âœ… CÃ³ | âŒ KhÃ´ng | âœ… CÃ³ | âœ… CÃ³ |
| **Cáº§n há»§y bá»?** | âœ… CÃ³ | âœ… CÃ³ | âŒ KhÃ´ng (chá»‰ sá»­a) | âŒ KhÃ´ng |
| **Táº¡o giao dá»‹ch má»›i?** | âœ… Äáº£o ngÆ°á»£c | âŒ KhÃ´ng | âœ… Giao dá»‹ch Ä‘Ãºng | âŒ KhÃ´ng |
| **Giá»¯ giao dá»‹ch gá»‘c?** | âœ… CÃ³ (reversed) | âš ï¸ CÃ³ (cancelled) | âœ… CÃ³ (replaced) | âœ… CÃ³ (active) |
| **Audit trail?** | âœ… Äáº§y Ä‘á»§ | âš ï¸ CÃ³ (nhÆ°ng áº©n) | âœ… Äáº§y Ä‘á»§ | âœ… Äáº§y Ä‘á»§ |
| **Tá»•ng impact** | 0Ä‘ | -(sá»‘ tiá»n gá»‘c) | KhÃ¡c gá»‘c | Giá»¯ nguyÃªn |

---

## ğŸ¯ DECISION TREE

```
Báº¡n cáº§n xá»­ lÃ½ giao dá»‹ch GD20251218-0694?
â”‚
â”œâ”€ Giao dá»‹ch ÄÃšNG?
â”‚  â””â”€ YES â†’ KHÃ”NG LÃ€M GÃŒ
â”‚
â”œâ”€ Giao dá»‹ch ÄÃƒ Xáº¢Y RA trong thá»±c táº¿?
â”‚  â”‚
â”‚  â”œâ”€ YES â†’ Cáº§n há»§y bá»?
â”‚  â”‚  â”‚
â”‚  â”‚  â”œâ”€ YES â†’ REVERSAL (táº¡o Ä‘áº£o ngÆ°á»£c)
â”‚  â”‚  â”‚
â”‚  â”‚  â””â”€ NO â†’ CÃ³ thÃ´ng tin sai?
â”‚  â”‚     â”‚
â”‚  â”‚     â”œâ”€ YES â†’ REPLACEMENT (thay tháº¿)
â”‚  â”‚     â”‚
â”‚  â”‚     â””â”€ NO â†’ KHÃ”NG LÃ€M GÃŒ
â”‚  â”‚
â”‚  â””â”€ NO (nháº­p nháº§m) â†’ SOFT DELETE (xÃ³a má»m)
```

---

## ğŸ’¡ VÃ Dá»¤ Cá»¤ THá»‚

### TÃ¬nh huá»‘ng 1: Há»§y hÃ³a Ä‘Æ¡n
```
Sá»± kiá»‡n:
18/12: Chi 360k mua hÃ ng tá»« nhÃ  cung cáº¥p A âœ… GHI
20/12: NCC A há»§y Ä‘Æ¡n, hoÃ n 360k

Xá»­ lÃ½:
â†’ REVERSAL giao dá»‹ch 18/12
â†’ LÃ½ do: "NCC há»§y Ä‘Æ¡n, hoÃ n tiá»n"
â†’ Káº¿t quáº£:
  - GD 18/12: CHI 360k (reversed)
  - REV 20/12: THU 360k (active)
  - Tá»•ng: 0Ä‘
  - Audit: Biáº¿t Ä‘Ã£ chi rá»“i hoÃ n
```

### TÃ¬nh huá»‘ng 2: Nháº­p nháº§m
```
Sá»± kiá»‡n:
18/12: NhÃ¢n viÃªn nháº­p: Chi 360k
Thá»±c táº¿: KHÃ”NG CÃ“ giao dá»‹ch nÃ y (duplicate)

Xá»­ lÃ½:
â†’ SOFT DELETE giao dá»‹ch 18/12
â†’ LÃ½ do: "Duplicate, nháº­p nháº§m"
â†’ Káº¿t quáº£:
  - GD 18/12: áº¨n (deleted_at set)
  - KhÃ´ng cÃ³ reversal
  - Sá»‘ dÆ° nhÆ° chÆ°a cÃ³ GD nÃ y
```

### TÃ¬nh huá»‘ng 3: Sai sá»‘ tiá»n
```
Sá»± kiá»‡n:
18/12: Ghi Chi 360k cho NCC A
HÃ³a Ä‘Æ¡n thá»±c: 320k (sai 40k)

Xá»­ lÃ½:
â†’ REPLACEMENT giao dá»‹ch 18/12
â†’ Dá»¯ liá»‡u má»›i: amount = 320k
â†’ LÃ½ do: "Sá»­a theo HÄ thá»±c táº¿"
â†’ Káº¿t quáº£:
  - GD cÅ© 18/12: CHI 360k (replaced, áº©n)
  - GD má»›i 02/01: CHI 320k (active, hiá»‡n)
  - Biáº¿t Ä‘Ã£ sá»­a tá»« 360k â†’ 320k
```

---

## âš ï¸ LÆ¯U Ã QUAN TRá»ŒNG

### 1. Reversal â‰  XÃ³a
```
[Äáº¢O NGÆ¯á»¢C] button:  Táº¡o giao dá»‹ch Ä‘á»‘i nghá»‹ch, giá»¯ nguyÃªn gá»‘c
[XÃ“A] button:        áº¨n giao dá»‹ch, khÃ´ng táº¡o Ä‘á»‘i nghá»‹ch

â†’ LÃ  2 HÃ€NH Äá»˜NG HOÃ€N TOÃ€N KHÃC NHAU!
```

### 2. Há»‡ thá»‘ng KHÃ”NG tá»± Ä‘á»™ng
```
âŒ Sai: Click [XÃ“A] â†’ Há»‡ thá»‘ng táº¡o reversal
âœ… ÄÃºng: Click [Äáº¢O NGÆ¯á»¢C] â†’ Há»‡ thá»‘ng táº¡o reversal
```

### 3. UI cáº§n cÃ³ 2 nÃºt riÃªng
```
MÃ n hÃ¬nh giao dá»‹ch cáº§n cÃ³:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ [Äáº¢O NGÆ¯á»¢C]  [THAY THáº¾]  [XÃ“A] â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
   â†“              â†“          â†“
Reversal    Replacement  Soft Delete
```

---

## ğŸ”§ IMPLEMENTATION CHO UI

### Button [Äáº¢O NGÆ¯á»¢C]
```javascript
// Vue/Blade
<button @click="reverseTransaction">
  Äáº¢O NGÆ¯á»¢C
</button>

// Action
async reverseTransaction() {
  const reason = prompt("LÃ½ do Ä‘áº£o ngÆ°á»£c:");
  if (!reason) return;
  
  await axios.post('/api/transactions/reverse', {
    transaction_id: this.transaction.id,
    reason: reason
  });
  
  alert("ÄÃ£ táº¡o giao dá»‹ch Ä‘áº£o ngÆ°á»£c!");
}
```

### Button [XÃ“A]
```javascript
<button @click="deleteTransaction">
  XÃ“A
</button>

async deleteTransaction() {
  const reason = prompt("LÃ½ do xÃ³a:");
  if (!reason) return;
  
  if (!confirm("XÃ¡c nháº­n XÃ“A (khÃ´ng táº¡o reversal)?")) {
    return;
  }
  
  await axios.post('/api/transactions/soft-delete', {
    transaction_id: this.transaction.id,
    reason: reason
  });
  
  alert("ÄÃ£ xÃ³a giao dá»‹ch!");
}
```

### Button [THAY THáº¾]
```javascript
<button @click="showReplaceForm">
  THAY THáº¾
</button>

async replaceTransaction(newData) {
  const reason = prompt("LÃ½ do thay tháº¿:");
  if (!reason) return;
  
  await axios.post('/api/transactions/replace', {
    transaction_id: this.transaction.id,
    new_data: newData,
    reason: reason
  });
  
  alert("ÄÃ£ táº¡o giao dá»‹ch thay tháº¿!");
}
```

---

## âœ… Káº¾T LUáº¬N

**5 Ä‘iá»ƒm cá»‘t lÃµi:**

1. **Há»† THá»NG KHÃ”NG Tá»° Äá»˜NG** - NgÆ°á»i dÃ¹ng chá»§ Ä‘á»™ng chá»n
2. **REVERSAL â‰  XÃ“A** - LÃ  2 hÃ nh Ä‘á»™ng hoÃ n toÃ n khÃ¡c nhau
3. **Má»–I TÃŒNH HUá»NG CÃ“ GIáº¢I PHÃP RIÃŠNG** - KhÃ´ng cÃ³ one-size-fits-all
4. **UI PHáº¢I RÃ• RÃ€NG** - 3 buttons riÃªng biá»‡t cho 3 actions
5. **AUDIT TRAIL LÃ€ QUAN TRá»ŒNG** - Giá»¯ láº¡i lá»‹ch sá»­ thay Ä‘á»•i

**Workflow Ä‘Ãºng:**
```
User phÃ¡t hiá»‡n váº¥n Ä‘á»
   â†“
User phÃ¢n tÃ­ch tÃ¬nh huá»‘ng
   â†“
User CHá»ŒN action phÃ¹ há»£p
   â†“
User thá»±c hiá»‡n action
   â†“
System xá»­ lÃ½ THEO Lá»°A CHá»ŒN cá»§a user
```

**âŒ KHÃ”NG BAO GIá»œ tá»± Ä‘á»™ng táº¡o reversal khi user click [XÃ“A]!**
