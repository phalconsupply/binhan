# Há»† THá»NG Káº¾ TOÃN 3 Lá»šP - GIáº¢I THÃCH CHI TIáº¾T

## ğŸ¯ Má»¤C ÄÃCH VÃ€ Lá»¢I ÃCH

### Váº¥n Ä‘á» cÅ©:
```
âŒ Dá»¯ liá»‡u lÆ°u dáº¡ng text (from_account: "vehicle_4", to_account: "customer")
âŒ KhÃ´ng kiá»ƒm tra sá»‘ dÆ° trÆ°á»›c khi chi tiá»n
âŒ CÃ³ thá»ƒ táº¡o giao dá»‹ch lÃ m sá»‘ dÆ° Ã¢m báº¥t há»£p lÃ½
âŒ KhÃ³ theo dÃµi ai ná»£ ai, ai tráº£ tiá»n cho ai
âŒ KhÃ´ng cÃ³ chuáº©n káº¿ toÃ¡n, khÃ³ lÃ m bÃ¡o cÃ¡o tÃ i chÃ­nh
```

### Giáº£i phÃ¡p má»›i:
```
âœ… Dá»¯ liá»‡u chuáº©n hÃ³a vá»›i ID (from_account_id: 10, to_account_id: 5)
âœ… Kiá»ƒm tra sá»‘ dÆ° trÆ°á»›c má»—i giao dá»‹ch
âœ… KhÃ´ng cho phÃ©p chi tiá»n khi khÃ´ng Ä‘á»§
âœ… Há»‡ thá»‘ng tÃ i khoáº£n rÃµ rÃ ng cho tá»«ng xe, nhÃ¢n viÃªn, khÃ¡ch hÃ ng
âœ… Sá»• kÃ©p (double-entry) chuáº©n káº¿ toÃ¡n quá»‘c táº¿
```

---

## ğŸ“š 3 PHASE GIáº¢I THÃCH CHI TIáº¾T

### **PHASE 1: VALIDATION & CONSTRAINTS (Kiá»ƒm tra & RÃ ng buá»™c)**

#### TÃ¡c dá»¥ng:
**NgÄƒn cháº·n táº¡o giao dá»‹ch sai ngay tá»« Ä‘áº§u**

#### CÃ¡ch hoáº¡t Ä‘á»™ng:

**1. InsufficientBalanceException (Ngoáº¡i lá»‡ thiáº¿u tiá»n)**
```php
// VÃ Dá»¤: Xe 49B08879 hiá»‡n cÃ³ 28.3 triá»‡u
// Muá»‘n chi 30 triá»‡u cho sá»­a xe

TRY:
  Kiá»ƒm tra sá»‘ dÆ° xe 49B08879 = 28.3 triá»‡u
  Cáº§n chi 30 triá»‡u
  
  â†’ 28.3 triá»‡u < 30 triá»‡u âŒ
  
  â†’ Throw InsufficientBalanceException
  â†’ Hiá»‡n thÃ´ng bÃ¡o: "Xe 49B08879 khÃ´ng Ä‘á»§ tiá»n! Hiá»‡n cÃ³: 28.3tr, Cáº§n: 30tr, Thiáº¿u: 1.7tr"
  â†’ KHÃ”NG CHO Táº O GIAO Dá»ŠCH

IF sá»‘ dÆ° Ä‘á»§:
  â†’ Cho phÃ©p táº¡o giao dá»‹ch âœ…
```

**2. Database CHECK Constraints**
```sql
-- RÃ€NG BUá»˜C 1: Sá»‘ tiá»n pháº£i > 0
ALTER TABLE transactions 
ADD CONSTRAINT check_positive_amount 
CHECK (amount > 0);

-- KhÃ´ng thá»ƒ táº¡o giao dá»‹ch -5 triá»‡u hoáº·c 0Ä‘ âŒ

-- RÃ€NG BUá»˜C 2: MÃ£ giao dá»‹ch khÃ´ng trÃ¹ng
ALTER TABLE transactions 
ADD CONSTRAINT unique_transaction_code 
UNIQUE (code);

-- KhÃ´ng thá»ƒ táº¡o 2 giao dá»‹ch cÃ¹ng mÃ£ GD20251122-0035 âŒ
```

**3. Pessimistic Locking (KhÃ³a bi quan)**
```php
// VÃ Dá»¤: 2 ngÆ°á»i cÃ¹ng lÃºc táº¡o giao dá»‹ch cho xe 49B08879

NGÆ¯á»œI 1 (8:00:00.000):
  Lock xe 49B08879 (10 giÃ¢y)
  Kiá»ƒm tra sá»‘ dÆ°: 28.3 triá»‡u
  Táº¡o giao dá»‹ch chi 10 triá»‡u
  Cáº­p nháº­t sá»‘ dÆ°: 28.3 - 10 = 18.3 triá»‡u
  Unlock xe 49B08879

NGÆ¯á»œI 2 (8:00:00.001):
  Cá»‘ lock xe 49B08879 â†’ Bá»Š CHáº¶N (ngÆ°á»i 1 Ä‘ang lock)
  Chá»... chá»... chá»...
  NgÆ°á»i 1 unlock (8:00:10.000)
  â†’ BÃ¢y giá» má»›i lock Ä‘Æ°á»£c
  Kiá»ƒm tra sá»‘ dÆ°: 18.3 triá»‡u (Ä‘Ã£ bá»‹ ngÆ°á»i 1 trá»«)
  Táº¡o giao dá»‹ch chi 5 triá»‡u
  Cáº­p nháº­t sá»‘ dÆ°: 18.3 - 5 = 13.3 triá»‡u âœ…

â†’ KHÃ”NG Bá»Š RACE CONDITION, Dá»® LIá»†U CHÃNH XÃC
```

---

### **PHASE 2: ACCOUNT NORMALIZATION (Chuáº©n hÃ³a tÃ i khoáº£n)**

#### TÃ¡c dá»¥ng:
**Táº¡o há»‡ thá»‘ng tÃ i khoáº£n riÃªng biá»‡t cho má»—i Ä‘á»‘i tÆ°á»£ng**

#### CÃ¡ch hoáº¡t Ä‘á»™ng:

**1. Báº£ng `accounts` - Danh sÃ¡ch tÃ i khoáº£n**
```
â”Œâ”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID  â”‚ Code         â”‚ Name                       â”‚ Type     â”‚ Category  â”‚ Balance     â”‚
â”œâ”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1   â”‚ SYS-CUSTOMER â”‚ KhÃ¡ch hÃ ng (Nguá»“n thu)     â”‚ revenue  â”‚ customer  â”‚ -472,041,500â”‚
â”‚ 2   â”‚ SYS-INCOME   â”‚ Thu nháº­p khÃ¡c              â”‚ revenue  â”‚ income    â”‚ -20,000,000 â”‚
â”‚ 3   â”‚ SYS-EXTERNAL â”‚ BÃªn ngoÃ i                  â”‚ expense  â”‚ external  â”‚ 175,164,903 â”‚
â”‚ 7   â”‚ COMP-FUND    â”‚ Quá»¹ cÃ´ng ty                â”‚ asset    â”‚ company   â”‚ -6,901,000  â”‚
â”‚ 8   â”‚ COMP-RESERVEDâ”‚ Quá»¹ dá»± kiáº¿n chi            â”‚ liabilityâ”‚ company   â”‚ 48,000,000  â”‚
â”‚ 11  â”‚ VEH-4        â”‚ TÃ i khoáº£n xe 49B08879      â”‚ asset    â”‚ vehicle   â”‚ 28,309,575  â”‚
â”‚ 15  â”‚ STAFF-4      â”‚ TÃ i khoáº£n Nguyá»…n Cá»¯u Ninh  â”‚ expense  â”‚ staff     â”‚ 16,480,000  â”‚
â””â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**2. Migration tá»« string sang ID**
```php
// TRÆ¯á»šC (Há»‡ thá»‘ng cÅ©):
Transaction {
  from_account: "vehicle_4"     // TEXT
  to_account: "customer"        // TEXT
}

// SAU (Há»‡ thá»‘ng má»›i):
Transaction {
  from_account_id: 11           // ID trá» Ä‘áº¿n VEH-4
  to_account_id: 1              // ID trá» Ä‘áº¿n SYS-CUSTOMER
}

// Lá»¢I ÃCH:
âœ… Query nhanh hÆ¡n (so sÃ¡nh sá»‘ thay vÃ¬ text)
âœ… KhÃ´ng sai chÃ­nh táº£ ("vehicel_4", "custommer")
âœ… Äá»•i tÃªn tÃ i khoáº£n dá»… dÃ ng (chá»‰ sá»­a 1 chá»— trong báº£ng accounts)
âœ… CÃ³ thá»ƒ thÃªm thÃ´ng tin: loáº¡i tÃ i khoáº£n, mÃ´ táº£, parent account...
```

**3. VÃ­ dá»¥ thá»±c táº¿:**
```
GIAO Dá»ŠCH: KhÃ¡ch tráº£ tiá»n chuyáº¿n Ä‘i 147 triá»‡u

BÆ¯á»šC 1: TÃ¬m accounts
  Tá»«: KhÃ¡ch hÃ ng (ID: 1, Code: SYS-CUSTOMER)
  Äáº¿n: Quá»¹ cÃ´ng ty (ID: 7, Code: COMP-FUND)

BÆ¯á»šC 2: Kiá»ƒm tra
  KhÃ¡ch hÃ ng cÃ³ Ä‘á»§ tiá»n khÃ´ng?
  â†’ KhÃ¡ch hÃ ng lÃ  revenue (nguá»“n thu), khÃ´ng cáº§n kiá»ƒm tra âœ…

BÆ¯á»šC 3: Táº¡o transaction
  from_account_id: 1
  to_account_id: 7
  amount: 147,241,500

BÆ¯á»šC 4: Cáº­p nháº­t sá»‘ dÆ°
  KhÃ¡ch hÃ ng: -472,041,500 (sá»‘ Ã¢m = Ä‘ang ná»£)
  Quá»¹ cÃ´ng ty: +147,241,500 â†’ TÄƒng tiá»n
```

**4. ReconcileAccountBalances Command**
```bash
php artisan accounts:reconcile --all

# KIá»‚M TRA:
# Duyá»‡t qua tá»«ng tÃ i khoáº£n
# TÃ­nh láº¡i sá»‘ dÆ° tá»« Ä‘áº§u Ä‘áº¿n cuá»‘i = SUM(tiá»n vÃ o) - SUM(tiá»n ra)
# So sÃ¡nh vá»›i sá»‘ dÆ° Ä‘Ã£ lÆ°u trong Account.balance
# Náº¿u khÃ¡c nhau â†’ BÃ¡o lá»—i vÃ  sá»­a

Káº¾T QUáº¢:
âœ… All accounts are balanced! No discrepancies found.
```

---

### **PHASE 3: DOUBLE-ENTRY BOOKKEEPING (Sá»• kÃ©p)**

#### TÃ¡c dá»¥ng:
**Ãp dá»¥ng chuáº©n káº¿ toÃ¡n quá»‘c táº¿ - má»—i giao dá»‹ch cÃ³ 2 bÃºt toÃ¡n**

#### CÃ¡ch hoáº¡t Ä‘á»™ng:

**1. NguyÃªn táº¯c sá»• kÃ©p:**
```
Má»ŒI GIAO Dá»ŠCH = DEBIT (Ná»£) + CREDIT (CÃ³)

DEBIT (BÃªn trÃ¡i):
  - TÄƒng tÃ i sáº£n (Asset)
  - TÄƒng chi phÃ­ (Expense)
  - Giáº£m ná»£ pháº£i tráº£ (Liability)
  - Giáº£m doanh thu (Revenue)

CREDIT (BÃªn pháº£i):
  - Giáº£m tÃ i sáº£n (Asset)
  - Giáº£m chi phÃ­ (Expense)
  - TÄƒng ná»£ pháº£i tráº£ (Liability)
  - TÄƒng doanh thu (Revenue)

CÃ”NG THá»¨C VÃ€NG: DEBIT = CREDIT (luÃ´n luÃ´n báº±ng nhau)
```

**2. VÃ­ dá»¥ cá»¥ thá»ƒ:**

**VÃ Dá»¤ 1: Thu tiá»n tá»« khÃ¡ch hÃ ng 147 triá»‡u**
```
GIAO Dá»ŠCH:
  Tá»«: KhÃ¡ch hÃ ng â†’ Äáº¿n: Quá»¹ cÃ´ng ty
  Sá»‘ tiá»n: 147,241,500Ä‘

JOURNAL ENTRIES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Account                  â”‚ Debit        â”‚ Credit       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Quá»¹ cÃ´ng ty (Asset)      â”‚ 147,241,500  â”‚ 0            â”‚ â†’ TÃ i sáº£n tÄƒng
â”‚ KhÃ¡ch hÃ ng (Revenue)     â”‚ 0            â”‚ 147,241,500  â”‚ â†’ Doanh thu tÄƒng
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tá»”NG                     â”‚ 147,241,500  â”‚ 147,241,500  â”‚ âœ… BALANCED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã NGHÄ¨A:
- Quá»¹ cÃ´ng ty tÄƒng 147tr (cÃ³ thÃªm tiá»n)
- Doanh thu tÄƒng 147tr (ghi nháº­n thu nháº­p)
```

**VÃ Dá»¤ 2: Chi tiá»n sá»­a xe 10 triá»‡u**
```
GIAO Dá»ŠCH:
  Tá»«: Xe 49B08879 â†’ Äáº¿n: BÃªn ngoÃ i (garage)
  Sá»‘ tiá»n: 10,000,000Ä‘

JOURNAL ENTRIES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Account                  â”‚ Debit        â”‚ Credit       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ BÃªn ngoÃ i (Expense)      â”‚ 10,000,000   â”‚ 0            â”‚ â†’ Chi phÃ­ tÄƒng
â”‚ Xe 49B08879 (Asset)      â”‚ 0            â”‚ 10,000,000   â”‚ â†’ TÃ i sáº£n giáº£m
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tá»”NG                     â”‚ 10,000,000   â”‚ 10,000,000   â”‚ âœ… BALANCED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

Ã NGHÄ¨A:
- Chi phÃ­ sá»­a xe tÄƒng 10tr
- Tiá»n cá»§a xe giáº£m 10tr
```

**VÃ Dá»¤ 3: Tráº£ lÆ°Æ¡ng tÃ i xáº¿ 5 triá»‡u**
```
GIAO Dá»ŠCH:
  Tá»«: Quá»¹ cÃ´ng ty â†’ Äáº¿n: Nguyá»…n Cá»¯u Ninh
  Sá»‘ tiá»n: 5,000,000Ä‘

JOURNAL ENTRIES:
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Account                  â”‚ Debit        â”‚ Credit       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Nguyá»…n C.Ninh (Expense)  â”‚ 5,000,000    â”‚ 0            â”‚ â†’ Chi phÃ­ lÆ°Æ¡ng
â”‚ Quá»¹ cÃ´ng ty (Asset)      â”‚ 0            â”‚ 5,000,000    â”‚ â†’ Tiá»n quá»¹ giáº£m
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tá»”NG                     â”‚ 5,000,000    â”‚ 5,000,000    â”‚ âœ… BALANCED
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**3. Lá»£i Ã­ch cá»§a Sá»• kÃ©p:**

```
âœ… KIá»‚M TRA Tá»° Äá»˜NG:
   Tá»•ng Debit pháº£i = Tá»•ng Credit
   Náº¿u khÃ´ng báº±ng â†’ CÃ³ lá»—i trong dá»¯ liá»‡u

âœ… THEO DÃ•I Äáº¦Y Äá»¦:
   Má»—i giao dá»‹ch cÃ³ 2 máº·t
   Biáº¿t tiá»n Ä‘i tá»« Ä‘Ã¢u, Ä‘áº¿n Ä‘Ã¢u

âœ… BÃO CÃO TÃ€I CHÃNH:
   - Balance Sheet (Báº£ng cÃ¢n Ä‘á»‘i káº¿ toÃ¡n)
   - Income Statement (BÃ¡o cÃ¡o thu chi)
   - Cash Flow (LÆ°u chuyá»ƒn tiá»n tá»‡)

âœ… AUDIT TRAIL:
   CÃ³ thá»ƒ truy váº¿t má»i giao dá»‹ch
   Kiá»ƒm toÃ¡n dá»… dÃ ng
```

**4. Báº£ng transaction_lines:**
```sql
â”Œâ”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ ID â”‚ Transaction ID â”‚ Account ID â”‚ Debit        â”‚ Credit       â”‚ Description      â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1  â”‚ 35             â”‚ 7 (COMP)   â”‚ 147,241,500  â”‚ 0            â”‚ Thu tiá»n khÃ¡ch   â”‚
â”‚ 2  â”‚ 35             â”‚ 1 (CUST)   â”‚ 0            â”‚ 147,241,500  â”‚ Thu tiá»n khÃ¡ch   â”‚
â”œâ”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 3  â”‚ 36             â”‚ 3 (EXT)    â”‚ 10,000,000   â”‚ 0            â”‚ Chi sá»­a xe       â”‚
â”‚ 4  â”‚ 36             â”‚ 11 (VEH-4) â”‚ 0            â”‚ 10,000,000   â”‚ Chi sá»­a xe       â”‚
â””â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

KIá»‚M TRA:
SUM(Debit) = 157,241,500
SUM(Credit) = 157,241,500
âœ… BALANCED!
```

---

## ğŸ”„ LUá»’NG HOáº T Äá»˜NG HOÃ€N CHá»ˆNH

### Khi táº¡o giao dá»‹ch má»›i:

```
USER: Táº¡o giao dá»‹ch chi 30 triá»‡u sá»­a xe 49B08879

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: VALIDATION                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Kiá»ƒm tra sá»‘ tiá»n > 0? â†’ 30tr > 0 âœ…                     â”‚
â”‚ 2. Kiá»ƒm tra mÃ£ giao dá»‹ch trÃ¹ng? â†’ KhÃ´ng trÃ¹ng âœ…           â”‚
â”‚ 3. Lock tÃ i khoáº£n xe 49B08879 (10 giÃ¢y)                    â”‚
â”‚ 4. Kiá»ƒm tra sá»‘ dÆ° xe 49B08879 = 28.3tr                     â”‚
â”‚ 5. So sÃ¡nh: 28.3tr < 30tr âŒ                               â”‚
â”‚ 6. Throw InsufficientBalanceException                       â”‚
â”‚ 7. Unlock tÃ i khoáº£n                                         â”‚
â”‚ 8. Hiá»‡n thÃ´ng bÃ¡o lá»—i cho user                             â”‚
â”‚ 9. KHÃ”NG Táº O GIAO Dá»ŠCH                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

USER: Sá»­a láº¡i thÃ nh 20 triá»‡u

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 1: VALIDATION                                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Kiá»ƒm tra sá»‘ tiá»n > 0? â†’ 20tr > 0 âœ…                     â”‚
â”‚ 2. Lock tÃ i khoáº£n xe 49B08879                               â”‚
â”‚ 3. Kiá»ƒm tra sá»‘ dÆ° = 28.3tr                                  â”‚
â”‚ 4. So sÃ¡nh: 28.3tr >= 20tr âœ…                              â”‚
â”‚ 5. CHO PHÃ‰P Táº O                                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 2: ACCOUNT NORMALIZATION                              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. TÃ¬m Account xe 49B08879 (ID: 11, Code: VEH-4)           â”‚
â”‚ 2. TÃ¬m Account BÃªn ngoÃ i (ID: 3, Code: SYS-EXTERNAL)       â”‚
â”‚ 3. Táº¡o Transaction:                                         â”‚
â”‚    - from_account_id: 11                                    â”‚
â”‚    - to_account_id: 3                                       â”‚
â”‚    - amount: 20,000,000                                     â”‚
â”‚    - code: GD20260102-0565 (auto generate)                  â”‚
â”‚ 4. Cáº­p nháº­t sá»‘ dÆ°:                                          â”‚
â”‚    - Xe 49B08879: 28.3tr â†’ 8.3tr                           â”‚
â”‚    - BÃªn ngoÃ i: 175.16M â†’ 195.16M                          â”‚
â”‚ 5. LÆ°u transaction vÃ o DB                                   â”‚
â”‚ 6. Unlock tÃ i khoáº£n                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ PHASE 3: DOUBLE-ENTRY                                       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 1. Táº¡o Journal Entry 1:                                     â”‚
â”‚    - Account: BÃªn ngoÃ i (Expense)                           â”‚
â”‚    - Debit: 20,000,000 (Chi phÃ­ tÄƒng)                      â”‚
â”‚    - Credit: 0                                              â”‚
â”‚                                                             â”‚
â”‚ 2. Táº¡o Journal Entry 2:                                     â”‚
â”‚    - Account: Xe 49B08879 (Asset)                           â”‚
â”‚    - Debit: 0                                               â”‚
â”‚    - Credit: 20,000,000 (TÃ i sáº£n giáº£m)                     â”‚
â”‚                                                             â”‚
â”‚ 3. Kiá»ƒm tra: Debit = Credit?                               â”‚
â”‚    â†’ 20M = 20M âœ…                                           â”‚
â”‚                                                             â”‚
â”‚ 4. LÆ°u 2 journal entries vÃ o transaction_lines              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
              â†“
         âœ… HOÃ€N THÃ€NH
```

---

## ğŸ“Š BÃO CÃO CÃ“ THá»‚ Táº O

### 1. Trial Balance (Báº£ng cÃ¢n Ä‘á»‘i thá»­)
```
Táº¥t cáº£ tÃ i khoáº£n vá»›i Debit/Credit
Kiá»ƒm tra Tá»•ng Debit = Tá»•ng Credit

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Account                â”‚ Debit        â”‚ Credit       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ ASSETS (TÃ i sáº£n)       â”‚              â”‚              â”‚
â”‚  - Quá»¹ cÃ´ng ty         â”‚ 0            â”‚ 6,901,000    â”‚
â”‚  - Xe 49B08879         â”‚ 118,800,000  â”‚ 90,490,425   â”‚
â”‚  - Xe 51B50614         â”‚ 63,500,000   â”‚ 27,710,000   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ REVENUE (Doanh thu)    â”‚              â”‚              â”‚
â”‚  - KhÃ¡ch hÃ ng          â”‚ 0            â”‚ 472,041,500  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ EXPENSE (Chi phÃ­)      â”‚              â”‚              â”‚
â”‚  - BÃªn ngoÃ i           â”‚ 175,164,903  â”‚ 0            â”‚
â”‚  - LÆ°Æ¡ng Nguyá»…n C.N    â”‚ 16,480,000   â”‚ 0            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Tá»”NG                   â”‚ 897,427,903  â”‚ 897,427,903  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
âœ… BALANCED!
```

### 2. Income Statement (BÃ¡o cÃ¡o lÃ£i/lá»—)
```
DOANH THU:
  Thu tá»« khÃ¡ch hÃ ng    472,041,500Ä‘
  Thu nháº­p khÃ¡c         20,000,000Ä‘
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Tá»•ng doanh thu       492,041,500Ä‘

CHI PHÃ:
  Chi bÃªn ngoÃ i       (175,164,903Ä‘)
  Chi lÆ°Æ¡ng           (220,000,000Ä‘)
  Chi khÃ¡c            (...)
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Tá»•ng chi phÃ­        (xxx,xxx,xxxÄ‘)

LÃƒI/(Lá»–) RÃ’NG          xx,xxx,xxxÄ‘
```

### 3. Balance Sheet (Báº£ng cÃ¢n Ä‘á»‘i káº¿ toÃ¡n)
```
TÃ€I Sáº¢N:
  Quá»¹ cÃ´ng ty         -6,901,000Ä‘
  Xe 49B08879         28,309,575Ä‘
  Xe 51B50614         35,790,000Ä‘
  Xe 51B51291         16,030,000Ä‘
  Xe 86A31384         13,426,522Ä‘
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Tá»•ng tÃ i sáº£n        86,655,097Ä‘

Ná»¢ PHáº¢I TRáº¢:
  Quá»¹ dá»± kiáº¿n chi     48,000,000Ä‘
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Tá»•ng ná»£             48,000,000Ä‘

Vá»N CHá»¦ Sá» Há»®U:
  Vá»‘n gÃ³p             xxxÄ‘
  LÃ£i/(Lá»—) lÅ©y káº¿     xxxÄ‘
  â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  Tá»•ng vá»‘n            38,655,097Ä‘

Tá»”NG Ná»¢ + Vá»N        86,655,097Ä‘ âœ…
```

---

## ğŸ›¡ï¸ Báº¢O Vá»† Dá»® LIá»†U

### CÃ¡c táº§ng báº£o vá»‡:

```
Táº¦NG 1: APPLICATION (Laravel)
  â”œâ”€ InsufficientBalanceException
  â”œâ”€ Validation Rules
  â””â”€ Business Logic

Táº¦NG 2: SERVICE LAYER
  â”œâ”€ AccountBalanceService
  â”œâ”€ DoubleEntryService
  â””â”€ Pessimistic Locking

Táº¦NG 3: DATABASE
  â”œâ”€ CHECK Constraints
  â”œâ”€ UNIQUE Constraints
  â”œâ”€ Foreign Keys
  â””â”€ Transaction Rollback

Táº¦NG 4: AUDIT
  â”œâ”€ Journal Entries
  â”œâ”€ Balance Reconciliation
  â””â”€ Double-Entry Verification
```

---

## ğŸ¯ TÃ“M Táº®T

### Há»‡ thá»‘ng cÅ©:
```
Giao dá»‹ch â†’ LÆ°u vÃ o DB â†’ Xong
(KhÃ´ng kiá»ƒm tra gÃ¬, cÃ³ thá»ƒ sai dá»¯ liá»‡u)
```

### Há»‡ thá»‘ng má»›i:
```
Giao dá»‹ch 
  â†’ PHASE 1: Kiá»ƒm tra há»£p lá»‡ (sá»‘ dÆ°, constraints, locking)
  â†’ PHASE 2: Chuáº©n hÃ³a tÃ i khoáº£n (account IDs, relationships)
  â†’ PHASE 3: Sá»• kÃ©p (debit/credit, balance verification)
  â†’ LÆ°u vÃ o DB
  â†’ CÃ³ thá»ƒ audit, reconcile, táº¡o bÃ¡o cÃ¡o báº¥t cá»© lÃºc nÃ o
```

### Lá»£i Ã­ch tá»•ng thá»ƒ:
```
âœ… An toÃ n: KhÃ´ng thá»ƒ táº¡o giao dá»‹ch sai
âœ… ChÃ­nh xÃ¡c: Dá»¯ liá»‡u luÃ´n Ä‘Ãºng (double-entry balance)
âœ… Minh báº¡ch: Biáº¿t tiá»n Ä‘i Ä‘Ã¢u, Ä‘áº¿n Ä‘Ã¢u
âœ… Dá»… quáº£n lÃ½: Há»‡ thá»‘ng tÃ i khoáº£n rÃµ rÃ ng
âœ… ChuyÃªn nghiá»‡p: Chuáº©n káº¿ toÃ¡n quá»‘c táº¿
âœ… BÃ¡o cÃ¡o: Táº¡o má»i loáº¡i bÃ¡o cÃ¡o tÃ i chÃ­nh
âœ… Audit: Kiá»ƒm toÃ¡n dá»… dÃ ng
```

---

## ğŸ“ COMMANDS QUAN TRá»ŒNG

```bash
# Kiá»ƒm tra táº¥t cáº£ tÃ i khoáº£n cÃ³ Ä‘Ãºng khÃ´ng
php artisan accounts:reconcile --all

# Táº¡o journal entries cho giao dá»‹ch má»›i
php artisan transactions:generate-journal-entries

# Sync sá»‘ dÆ° tá»« journal entries
php artisan accounts:sync-from-journal

# TÃ­nh láº¡i sá»‘ dÆ° táº¥t cáº£ giao dá»‹ch
php artisan transactions:recalculate-balances

# Migration accounts tá»« string sang ID
php artisan accounts:migrate-transactions
```

---

**Káº¿t luáº­n:** Há»‡ thá»‘ng má»›i biáº¿n accounting tá»« "lÆ°u trá»¯ dá»¯ liá»‡u Ä‘Æ¡n giáº£n" thÃ nh "há»‡ thá»‘ng káº¿ toÃ¡n chuyÃªn nghiá»‡p" vá»›i Ä‘áº§y Ä‘á»§ kiá»ƒm tra, cÃ¢n Ä‘á»‘i, vÃ  kháº£ nÄƒng audit.
